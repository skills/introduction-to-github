name: ChRaismas Blueprint Deployment

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Target Network'
        required: true
        type: choice
        options:
          - hardhat
          - sepolia
          - mainnet
      component:
        description: 'Component to Deploy'
        required: true
        type: choice
        options:
          - raise-token
          - chraismas-nft
          - hollywood-dao
          - all

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'contracts/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./contracts
        run: npm ci
      
      - name: Create .env file
        working-directory: ./contracts
        run: |
          echo "PRIVATE_KEY=${{ secrets.DEPLOYER_PRIVATE_KEY }}" > .env
          echo "SEPOLIA_RPC_URL=${{ secrets.SEPOLIA_RPC_URL }}" >> .env
          echo "MAINNET_RPC_URL=${{ secrets.MAINNET_RPC_URL }}" >> .env
          echo "ETHERSCAN_API_KEY=${{ secrets.ETHERSCAN_API_KEY }}" >> .env
      
      - name: Compile contracts
        working-directory: ./contracts
        run: npm run compile
      
      - name: Deploy RAISE Token
        if: github.event.inputs.component == 'raise-token' || github.event.inputs.component == 'all'
        working-directory: ./contracts
        run: |
          echo "ðŸŽ„ Deploying RAISE Token to ${{ github.event.inputs.network }}..."
          npx hardhat run ../chraismas/scripts/deploy-raise-token.js --network ${{ github.event.inputs.network }}
      
      - name: Deploy ChRaismas NFT
        if: github.event.inputs.component == 'chraismas-nft' || github.event.inputs.component == 'all'
        working-directory: ./contracts
        run: |
          echo "ðŸŽ„ Deploying ChRaismas NFT to ${{ github.event.inputs.network }}..."
          npx hardhat run ../chraismas/scripts/deploy-chraismas-nft.js --network ${{ github.event.inputs.network }}
      
      - name: Deploy Hollywood DAO
        if: github.event.inputs.component == 'hollywood-dao' || github.event.inputs.component == 'all'
        working-directory: ./contracts
        env:
          CHRAISMAS_NFT_ADDRESS: ${{ secrets.CHRAISMAS_NFT_ADDRESS }}
        run: |
          echo "ðŸŽ¬ Deploying Hollywood DAO to ${{ github.event.inputs.network }}..."
          if [ -z "$CHRAISMAS_NFT_ADDRESS" ]; then
            echo "âš ï¸  Warning: CHRAISMAS_NFT_ADDRESS not set. Skipping Hollywood DAO deployment."
            echo "Please deploy ChRaismas NFT first and set the secret."
            exit 0
          fi
          npx hardhat run ../chraismas/scripts/deploy-hollywood-dao.js --network ${{ github.event.inputs.network }}
      
      - name: Save deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-artifacts-${{ github.event.inputs.network }}
          path: |
            contracts/artifacts/
            contracts/cache/
          retention-days: 90
      
      - name: Deployment Summary
        run: |
          echo "## ðŸŽ„ ChRaismas Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Network**: ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Component**: ${{ github.event.inputs.component }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
